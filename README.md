# Max transaction amount category by states calculator

DISCLAIMER

–î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ —Ä–∞–º–∫–∞—Ö —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è https://www.kaggle.com/competitions/teta-ml-1-2025/data?select=train.csv

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:
1. **`state_stats_calculator`** (–û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å):
    - –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª `data/transactions.csv` –≤ —Ç–æ–ø–∏–∫ `clickhouse` –∫–∞—Ñ–∫–∞
    - –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç Materialized View –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–æ–ø–∏–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É
    - –°—á–∏—Ç–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ `output/transactions_stats_by_states.csv`

2. **`kafka infrastructure`**:
   - Zookeeper + Kafka –±—Ä–æ–∫–µ—Ä
   - `kafka-setup`: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–ø–∏–∫ `clickhouse`
   - Kafka UI: –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ—Ä—Ç 8080)

4. **`clickhouse`**:
   - –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–æ—Ä–∏–Ω–≥–∞ –∏–∑ —Ç–æ–ø–∏–∫–∞ kafka `clickhouse` –ø—Ä–∏ –ø–æ–º–æ—â–∏ Materialized View –∏ Kafka Engine
   - –í—ã–≥—Ä—É–∂–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü—É `transactions_data`

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –ó–∞–ø—É—Å–∫
```bash
git clone https://github.com/zxcebanat111/mlops_hw3.git
cd mlops_hw3

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up --build
```
–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞:
- **Kafka UI**: http://localhost:8080
- **Clickhouse UI**: http://localhost:8123/play
- **–õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤**:
  ```bash
  docker-compose logs <service_name>  # –ù–∞–ø—Ä–∏–º–µ—Ä: state_stats_calculator

## üõ†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:

 - –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –ø–æ –ø—É—Ç–∏ `data/transactions.csv`. –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ–∞–π–ª —Ñ–æ—Ä–º–∞—Ç–∞ `train.csv` –∏–∑ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è https://www.kaggle.com/competitions/teta-ml-1-2025
 - –ü—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–ª—è `us_state`, `cat_id`, `amount`
 - –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö:
    ```csv
    us_state,cat_id,amount,lat,lon,merchant_lat,merchant_lon,gender,...
    TX,grocery_pos,150.50,40.7128,-74.0060,40.7580,-73.9855,M,...
    ```
 - –î–ª—è –ø–µ—Ä–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∂–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–π —Å–µ–º–ø–ª –¥–∞–Ω–Ω—ã—Ö (–¥–æ 100 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π) –∑–∞ —Ä–∞–∑, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–¥–∞ –Ω–µ –∑–∞–Ω—è–ª–æ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏.

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
 - **Kafka UI**: –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Ç–æ–ø–∏–∫–µ `clickhouse`
 - **–õ–æ–≥–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏**: docker-compose logs state_stats_calculator

### 3. –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

 - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–∞–ø–∏—Å–∞–Ω—ã –ø–æ –ø—É—Ç–∏ `output/transactions_stats_by_states.csv` —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
    ```json
    {
    "us_state": TX, 
    "top_category": grocery_pos, 
    "max_total": 363311.34,
    }
    ```
## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```
.
‚îú‚îÄ‚îÄ state_stats_calculator
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ queries
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ init_materialized_view.sql   # –∑–∞–ø—Ä–æ—Å –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Materialized View –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Kafka
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ calculate_stats.sql          # –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ lib
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ load_data.py                 # —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–æ–ø–∏–∫ Kafka
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ clickhouse.py                # —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å clickhouse: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Materialized View –∏ –ø–æ–¥—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ app.py                           # –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å
‚îú‚îÄ‚îÄ init_clickhouse
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ init.sql                         # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü clickhouse
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ README.md
```
## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Clickhouse
1. –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç–æ–ø–∏–∫–∞ Kafka –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–µ–Ω—É–∂–Ω—ã–µ –ø–æ–ª—è
2. –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–∞–º—ã—Ö –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–∞—Ö:
   - FixedString(2) –¥–ª—è –∫–æ–¥–∞ —à—Ç–∞—Ç–∞
   - LowCardinality(String) –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç–∞–∫ –∫–∞–∫ –∏—Ö –≤—Å–µ–≥–æ 14
   - Decimal(7,2) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–æ—á–Ω–æ—Å—Ç—å –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ –≤—ã–¥–µ–ª—è—Ç—å –ª–∏—à–Ω—é—é –ø–∞–º—è—Ç—å
3. –¢–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–∑—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ AggregatingMergeTree, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ–ª—å—à–æ–≥–æ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö
4. –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ —à—Ç–∞—Ç–∞–º –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å–∂–∞—Ç–∏—è –¥–∞–Ω–Ω—ã—Ö
